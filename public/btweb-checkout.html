<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Braintree SDK + PayPal SDK v5 Checkout Flow</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label,
        input,
        button,
        select {
            display: block;
            margin-bottom: 5px;
        }

        input,
        select {
            padding: 8px;
            width: 100%;
            max-width: 400px;
        }

        button {
            padding: 10px;
            background-color: #0070f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            max-width: 200px;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
    <script src="https://js.braintreegateway.com/web/3.119.0-paypal-appswitch.5/js/client.js"></script>
    <script src="https://js.braintreegateway.com/web/3.119.0-paypal-appswitch.5/js/paypal-checkout.js"></script>
</head>

<body>
    <div class="container">
        <main>
            <h1>Braintree SDK + PayPal SDK v5</h1>
            <p>
                This demo uses Braintree v3.119.0-paypal-appswitch.5 and PayPal v5
                One-time Checkout Flow
            </p>
            <div id="paypal-button"></div>
            <div id="result"></div>
        </main>
    </div>

    <script>
        // Constants
        const braintreeSDKVersion = "3.119.0-paypal-appswitch.5";

        const getConfig = async () => {
            const response = await fetch("/api/paypal/client-config");
            const data = await response.json();
            console.log(`Environment: ${data.environment}`);
            return data;
        };
        getConfig().then((config) => {
            const flows = {
                "1 time checkout": {
                    amount: 0.25,
                    currency: "USD",
                    flow: "checkout",
                    intent: "capture",
                    redirectUrl: "https://www.example.com/",
                },
                "Vault Flow": {
                    amount: 0.25,
                    currency: "USD",
                    flow: "vault",
                    redirectUrl: "https://www.example.com/",
                },
            };
            const createPaymentOptions = {
                returnUrl: "https://www.example.com/",
                cancelUrl: "https://www.example.com/",
                // returnUrl: new URL(window.location.href),
                // cancelUrl: new URL(window.location.href),
                appSwitchPreference: {
                    launchPaypalApp: true,
                },
            }

            // Element references
            const braintreeContainer =
                document.getElementById("braintreeContainer");

            // State variables
            let btAuth = config.braintreeTokenizationKey;
            let currentFlow = "1 time checkout";
            let resultElement = document.getElementById('result');

            const transact = async (nonce) => {
                let url =
                    config.environment === "sandbox"
                        ? "https://payments.sandbox.braintree-api.com/graphql"
                        : "https://payments.braintree-api.com/graphql";
                const graphqlQuery = {
                    query: `mutation {
                    chargePaymentMethod(input: {
                        paymentMethodId: "${nonce}",
                        transaction: {amount: "0.25"}
                        }) {
                            transaction {
                                id
                                status
                                legacyId
                                merchantAccountId
                                orderId
                                }
                                }
                                }`,
                };
                const priv = config.braintreePrivateKey;
                const pub = config.braintreePublicKey;

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        Authorization: `Basic ${btoa(pub + ":" + priv)}`,
                        "Braintree-version": "2025-06-03",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(graphqlQuery),
                });
                const txn = await response.json();
                console.log(txn);
            };
            window.braintree.client.create({ authorization: btAuth })
                .then((clientInstance) => {
                    window.braintree.paypalCheckout.create({ client: clientInstance })
                        .then((paypalCheckoutInstance) => {
                            paypalCheckoutInstance.loadPayPalSDK({
                                intent: "capture",
                                currency: "USD",
                            }).then(() => {

                                const buttons = window.paypal.Buttons({
                                    appSwitchWhenAvailable: true,
                                    fundingSource: window.paypal.FUNDING.PAYPAL,
                                    createOrder: () => {
                                        return paypalCheckoutInstance.createPayment({
                                            ...flows[currentFlow],
                                            ...createPaymentOptions,
                                        });
                                    },
                                    onApprove: (data) => {
                                        return paypalCheckoutInstance.tokenizePayment(
                                            data,
                                            (err, payload) => {
                                                if (err) {
                                                    console.error("There was an error with tokenization: ", err);
                                                    return;
                                                }
                                                resultElement.innerHTML = JSON.stringify(payload);
                                                transact(payload.nonce)
                                                console.log("Got a nonce payload: ", payload);
                                            }
                                        );
                                    },
                                    onCancel: (data) => {
                                        console.log("Paypal Payment Cancelled: ", JSON.stringify(data, null, 2));
                                    },
                                    onError: (err) => {
                                        console.error("PayPal Error: ", err);
                                    },
                                });

                                if (buttons.hasReturned && buttons.hasReturned()) {
                                    buttons.resume();
                                } else {
                                    buttons.render("#paypal-button");
                                }
                            });
                        })
                })
        })

      ;
    </script>
</body>

</html>